# DevOps

基本术语：

- CI：持续集成 --- 在开发->构建->测试的过程中，将构建和测试的过程通过工具实现自动化，那么整个流程就变成了由开发提交程序，构建和测试过程中如果出现错误，则自动打回给开发修改，修改后再次提交，直到程序测试完成，此流程为持续集成
- CD：持续交付，Delivery --- 如果程序测试完成后能够自动将程序打包，并将其发送到运维人员或客户能够直接拿到的共享存储上，让运维人员能够得到最终产品，整个流程自动化就称为持续交付
- CD：持续部署，Deployment --- 如果交付完成后能有一个工具自动触发后将程序发布到线上，称为持续部署

```diff
+ 整个从CI到CD的三步流程中，都通过自动循环实现，每一个环节都持续不断的向前进行反馈。如构建过程中，可能会出现一些此前未见过的bug，快速将其反馈给开发，修改后再上线，整个流程自动化则称为DevOps
```

# kubernetes

#### 特性

- 自动装箱：基于资源依赖及其约束能够自动完成容器的部署而不影响其可用性
- 自我修复：容器内进程错误时会删除此容器并创建一个新的容器顶替
- 水平扩展
- 服务发现和负载均衡
- 自动发布和回滚
- 密钥和配置管理：将容器启动时需要的配置文件放在一台设备上，便于集中化管理
- 存储编排
- 批量处理执行

#### 集群

集群分为两种，P2P和中心节点型，kubernetes属于有中心节点型架构的集群（Masters/Nodes），Masters节点作为整个集群的唯一入口，用户的所有请求都会先发到Masters节点，Masters通过调度器分析各Nodes节点中现有的可用资源状态，找一个最佳适配用户所请求的容器节点，并将其调度上去，再由Nodes节点上的容器引擎启动容器

#### Masters节点的三个核心组件

1. API Server：负责接收并处理请求
2. Seheduler：调度器，根据容器启动的最低需求进行评估哪一个Nodes最合适。kubernetes通过两级调度机制，首先挑选出所有满足容器需求的Nodes，然后通过设置的调度算法在其中选出最佳适配节点，这两级调度分别是predict（预算策略）和priorities（优选则略）
3. Controller Manager：控制器管理器，负责监控每一个控制器的健康。在Masters节点中每一台设备都有控制器管理器，但只有一个控制器管理器是工作的，其他的控制器管理器都作为冗余

> Pod控制器：kubernetes有很多种控制器，包括但不限于检测Nodes节点上的容器运行是否健康的控制器，常见的有以下几种：
>
> - ReplicationController：副本控制器，k8s最早的控制器之一，负责控制同一类Pod对象的各种副本，自动调整副本数量，精确符合管理员所定义的副本数量
> - ReplicaSet：此Pod控制器不直接使用，它有一个声明式更新控制器：Deployment
> - Deployment：只能管理无状态请求，而有状态请求则需要依靠StatefulSet控制器
> - StatefulSet：负责管理有状态请求
> - DaemonSet：如果需要在每一个Nodes节点上运行一个副本，而不是随意运行，则需要DaemonSet控制器
> - Job,Cronjob：一次性计划任务启动Pod或周期计划任务检测Pod副本数量

#### Pod

pod是作为kubernetes的一个逻辑组件，且作为kubernetes上的**最小运行单元**，在Nodes节点上时看不到pod的，kubernetes并不直接调度容器的运行，pod可以看作是容器的外壳，给容器做了一层抽象的封装，一个pod可以包含多个容器，且多个容器共享一个底层的网络名称空间，为一个pod挂载存储卷时相当于pod内的所有容器共享同一个存储卷

```diff
- 一般一个pod中只放一个容器，如果在同一pod中需要放多个容器，通常有一个容器是主容器，其他容器是为了辅助主容器中的程序完成更多的功能来实现的，这种多容器运行在一个Pod中又称为边车（SideCar）模式
```

调度器实际上是调度的pod，在Nodes节点上运行的也是pod，且pod是一个原子单元，无论pod中有一个或多个容器，一旦将pod调度到某一Nodes节点上运行后，此pod中所有的容器都只能运行在同一个Nodes节点上

#### Label Selector

一个集群中存在多个Nodes节点，而Nodes节点向上提供资源池，资源池之上则是众多个pod，为了实现在众多pod中精准识别某个pod，或者将某一类pod归组，比如将4个nginx的pod统归于一个控制器进行管理，则需要为pod附加一些元数据，比如打标签，而标签则是key/value类型的数据，比如创建4个nginx的pod时设置key=app，则只有key=app且value=nginx时才能筛选出这4个pod，这种筛选机制则需要通过组件Label Selector来实现

一个标签可以对应多个资源（Pod），一个资源也可以有多个标签，实现不同维度的管理。与标签类似的还有一种annotations（注解），这两者的区别在于标签对字符的要求更加严格。

#### Nodes节点的组件

1. kubelet：集群代理，与API Server通信，接收并执行由Masters节点调度过来的各种任务，定时向API Server汇报当前节点状态，以供调度时使用，负责镜像和容器的清理工作，保证节点上镜像不会占满磁盘空间
2. docker：容器引擎，kubelet接收任务并**试图**启动容器，但kubelet并不能直接运行容器，真正启动容器需要容器引擎，docker并不是唯一的容器引擎，但却是最流行的

3. kube-proxy：Service资源的载体，随时与API Server进行通信，管理Service，建立了Pod网络和集群网络的关系（clusterip -> podip），常用的3中流量调度模式：Userspace、Iptables、ipvs

